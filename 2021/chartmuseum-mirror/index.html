<!doctype html><html lang=en><head><title>Chartmuseum Mirror :: vanderVeer.be</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Since the stable and incubation helm chart repositories are deprecated, charts are published in a multitude of locations. Unfortunately not all these locations are as stable as you would expect them to be. In this post we will setup Chartmuseum on a Kubernetes cluster, backed by AWS S3 and use it and Github Actions to publish our own charts and mirror the repositoreis we need.
Using Pulumi to bootstrap our infrastructure Pulumi is a tool that allows us to leverage familiar programming languages to define our infrastructure as code."><meta name=keywords content=","><meta name=robots content="noodp"><link rel=canonical href=https://vanderveer.be/2021/chartmuseum-mirror/><link rel=stylesheet href=https://vanderveer.be/assets/style.css><link rel=stylesheet href=https://vanderveer.be/assets/red.css><link rel=apple-touch-icon href=https://vanderveer.be/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=https://vanderveer.be/img/favicon/red.png><meta name=twitter:card content="summary"><meta name=twitter:site content="https://vanderveer.be"><meta name=twitter:creator content="r0derik"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Chartmuseum Mirror"><meta property="og:description" content="Since the stable and incubation helm chart repositories are deprecated, charts are published in a multitude of locations. Unfortunately not all these locations are as stable. In this post we will setup Chartmuseum on a Kubernetes cluster, backed by AWS S3 and use it and Github Actions to publish our own charts and mirror the repositoreis we need."><meta property="og:url" content="https://vanderveer.be/2021/chartmuseum-mirror/"><meta property="og:site_name" content="vanderVeer.be"><meta property="og:image" content="https://vanderveer.be/"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2021-02-24 17:57:35 +0100 +0100"></head><body class=red><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>vanderVeer.be</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about>About</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about>About</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=https://vanderveer.be/2021/chartmuseum-mirror/>Chartmuseum Mirror</a></h1><div class=post-meta><span class=post-date>2021-02-24 [Updated: 2021-02-25]</span>
<span class=post-author>:: Roderik van der Veer</span></div><span class=post-tags>#<a href=https://vanderveer.be/tags/devops/>devops</a>&nbsp;
#<a href=https://vanderveer.be/tags/helm/>helm</a>&nbsp;
#<a href=https://vanderveer.be/tags/chartmuseum/>chartmuseum</a>&nbsp;</span><div class=post-content><div><p>Since the stable and incubation helm chart repositories are deprecated, charts are published in a multitude of locations. Unfortunately not all these locations are as stable as you would expect them to be. In this post we will setup Chartmuseum on a Kubernetes cluster, backed by AWS S3 and use it and Github Actions to publish our own charts and mirror the repositoreis we need.</p><h2 id=using-pulumi-to-bootstrap-our-infrastructure>Using Pulumi to bootstrap our infrastructure<a href=#using-pulumi-to-bootstrap-our-infrastructure class=hanchor arialabel=Anchor>&#8983;</a></h2><p><a href=https://www.pulumi.com>Pulumi</a> is a tool that allows us to leverage familiar programming languages to define our infrastructure as code. In this post we will be using the Typescript version of Pulumi together with a free account.</p><p>Let&rsquo;s install Pulumi using <a href=https://brew.sh>Homebrew</a> since I use MacOS. You can use Pulumi on any operating system and <a href=https://www.pulumi.com/docs/get-started/install/>the installation instructions can be found in the documentation</a>. FYI, a lot of the Pulumi code samples is copied from the Pulumi documentation, the go-to source for anything you want to do with Pulumi.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>brew install pulumi
</code></pre></div><p>You will also need a free account from the <a href=https://www.pulumi.com>Pulumi website</a>. This account is used to store the state of your infrastructure. You can also use your own backend if you do not feel comfortable using the Pulumi backend, the configuration of this can be found in <a href=https://www.pulumi.com/docs/guides/self-hosted/>the docs</a>.</p><p>Using this account, you can log in on your computer</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>pulumi login
</code></pre></div><p>In your account settings, under Access Tokens, you need to create a new token. Save the token for the future steps. It looks like this (obviously this is not my token ðŸ¤¦):</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>pul-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
</code></pre></div><p>This handled, we will create the Pulumi stack for this tutorial.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>mkdir chartmuseum-tutorial <span style=color:#f92672>&amp;&amp;</span> cd chartmuseum-tutorial
pulumi new aws-typescript
</code></pre></div><p>The Pulumi CLI will ask you some questions to complete the setup</p><ul><li>Enter in a Pulumi project name, and description to detail what this Pulumi program does</li><li>Enter in a name for the Pulumi stack, which is an instance of our Pulumi program, and is used to distinguish amongst different development phases and environments of your work streams.</li><li>Your preferred AWS zone</li></ul><h2 id=setting-up-the-kubernetes-cluster-on-eks>Setting up the Kubernetes Cluster on EKS<a href=#setting-up-the-kubernetes-cluster-on-eks class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Let&rsquo;s start off by creating the cluster. First we need to add some more dependencies.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>npm install --save @pulumi/eks @pulumi/kubernetes
</code></pre></div><p>Open the existing file index.ts, and replace the contents with the following:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=color:#66d9ef>import</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>pulumi</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;@pulumi/pulumi&#34;</span>;
<span style=color:#66d9ef>import</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>awsx</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;@pulumi/awsx&#34;</span>;
<span style=color:#66d9ef>import</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>eks</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;@pulumi/eks&#34;</span>;
<span style=color:#66d9ef>import</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>k8s</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;@pulumi/kubernetes&#34;</span>;

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>name</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;chartmuseum&#34;</span>;

<span style=color:#75715e>// Create an EKS cluster with non-default configuration
</span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>vpc</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>awsx</span>.<span style=color:#a6e22e>ec2</span>.<span style=color:#a6e22e>Vpc</span>(<span style=color:#e6db74>&#34;vpc&#34;</span>, { <span style=color:#a6e22e>subnets</span><span style=color:#f92672>:</span> [{ <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;public&#34;</span> }] });
<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>cluster</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>eks</span>.<span style=color:#a6e22e>Cluster</span>(<span style=color:#a6e22e>name</span>, {
    <span style=color:#a6e22e>vpcId</span>: <span style=color:#66d9ef>vpc.id</span>,
    <span style=color:#a6e22e>subnetIds</span>: <span style=color:#66d9ef>vpc.publicSubnetIds</span>,
    <span style=color:#a6e22e>desiredCapacity</span>: <span style=color:#66d9ef>2</span>,
    <span style=color:#a6e22e>minSize</span>: <span style=color:#66d9ef>1</span>,
    <span style=color:#a6e22e>maxSize</span>: <span style=color:#66d9ef>2</span>,
    <span style=color:#a6e22e>storageClasses</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;gp2&#34;</span>,
    <span style=color:#a6e22e>deployDashboard</span>: <span style=color:#66d9ef>false</span>,
});

<span style=color:#75715e>// Export the clusters&#39; kubeconfig.
</span><span style=color:#75715e></span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>kubeconfig</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>cluster</span>.<span style=color:#a6e22e>kubeconfig</span>
</code></pre></div><p>The index.ts occupies the role as the main entrypoint in our Pulumi program. In it, we are going to declare:</p><ul><li>The resources we want in AWS to provision the EKS cluster based on our cluster configuration settings,</li><li>The kubeconfig file to access the cluster, and</li><li>The initialization of a Pulumi Kubernetes provider with the kubeconfig, so that we can deploy Kubernetes resources to the cluster once its ready in the next steps.</li></ul><p>You will notice that there is hardly any configuration needed. But this does not mean you cannot tune everything to your harts content. Since we use typescrupt, you can easily find all configuration settings in the type definitions of the <code>ClusterOptions</code> argument.</p><p>Before we can deploy this cluster, we still need to configure our AWS credentials, there are many options, choose your poison <a href=https://www.pulumi.com/docs/intro/cloud-providers/aws/#configuration>in the AWS provider documentation</a>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>pulumi config set aws:accessKey AAAAAAAAAAAAAAAAAAAA --secret
pulumi config set aws:secretKey m/ZTX/xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx --secret
</code></pre></div><p>By using &ndash;secret, the value is encrypted and you can commit it to git. It stores these configuration values in the Pulumi.stackname.yaml file.</p><p>We can not deploy the cluster by running</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>pulumi up
</code></pre></div><img src=/images/2021/chartmuseum-mirror/clustercreation.gif alt="Cluster creation with pulumi up" class=center style=border-radius:8px><h2 id=deploying-chartmuseum-on-our-cluster>Deploying ChartMuseum on our cluster<a href=#deploying-chartmuseum-on-our-cluster class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Since we are going to need a domainname pointed tot he chartmuseum instance, we will add a <a href=https://cloudflare.com>Cloudflare</a> dependency so we can use it to create and manage the domainname. Pulumi supports a lot of DNS providers, as stated before, check the docs for other setups.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>npm install --save @pulumi/cloudflare
</code></pre></div><p>In this case, I&rsquo;ll assume your domainname is already configured in Cloudflare. We will first need your domainnames Zone ID which we will set in the config.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>pulumi config set zoneId xxxxxxxxxxxxxxxxxxxxx --secret
pulumi config set cloudflare:email roderik@vanderveer.be
pulumi config set cloudflare:apiKey xxxxxxxxxxxxxxxxxxxxx --secret
</code></pre></div><p>Notice that I set the Zone Id as a secret, while it is not secret, I do not want to expose it in the public GIT repo for this post.</p><p>We will start adding a namespace, ingress controller and link the domainname to it. At the bottom of the index.ts file, add the following.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=color:#75715e>// Create a k8s provider
</span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>provider</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>k8s</span>.<span style=color:#a6e22e>Provider</span>(<span style=color:#e6db74>&#39;k8s&#39;</span>, { <span style=color:#a6e22e>kubeconfig</span> });

<span style=color:#75715e>// Setup a namespace
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>k8s</span>.<span style=color:#a6e22e>core</span>.<span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>Namespace</span>(
  <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>name</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-namespace`</span>,
  { <span style=color:#a6e22e>metadata</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>name</span> } },
  { <span style=color:#a6e22e>provider</span> }
);

<span style=color:#75715e>// Deploy an ingress controller into it
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>nginxIngress</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>k8s</span>.<span style=color:#a6e22e>helm</span>.<span style=color:#a6e22e>v3</span>.<span style=color:#a6e22e>Chart</span>(
  <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>name</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-ingress`</span>,
  {
    <span style=color:#a6e22e>chart</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;ingress-nginx&#39;</span>,
    <span style=color:#a6e22e>version</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;3.15.2&#39;</span>,
    <span style=color:#a6e22e>fetchOpts</span><span style=color:#f92672>:</span> {
      <span style=color:#a6e22e>repo</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;https://kubernetes.github.io/ingress-nginx&#39;</span>,
    },
    <span style=color:#66d9ef>namespace</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>name</span>,
    <span style=color:#a6e22e>values</span><span style=color:#f92672>:</span> {
      <span style=color:#a6e22e>controller</span><span style=color:#f92672>:</span> {
        <span style=color:#a6e22e>scope</span><span style=color:#f92672>:</span> {
          <span style=color:#a6e22e>enabled</span>: <span style=color:#66d9ef>true</span>,
        },
        <span style=color:#a6e22e>replicaCount</span>: <span style=color:#66d9ef>2</span>,
        <span style=color:#a6e22e>metrics</span><span style=color:#f92672>:</span> {
          <span style=color:#a6e22e>enabled</span>: <span style=color:#66d9ef>true</span>,
        },
        <span style=color:#a6e22e>admissionWebhooks</span><span style=color:#f92672>:</span> {
          <span style=color:#a6e22e>enabled</span>: <span style=color:#66d9ef>false</span>,
        },
      },
    },
  },
  {
    <span style=color:#a6e22e>provider</span>,
    <span style=color:#a6e22e>ignoreChanges</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#39;status&#39;</span>, <span style=color:#e6db74>&#39;metadata&#39;</span>],
  }
);

<span style=color:#75715e>// Fetch the ingress URL from the service
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>controllerService</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>nginxIngress</span>.<span style=color:#a6e22e>getResource</span>(
  <span style=color:#e6db74>&#39;v1/Service&#39;</span>,
  <span style=color:#a6e22e>name</span>,
  <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>name</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-ingress-ingress-nginx-controller`</span>
);

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>ingressUrl</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>controllerService</span>.<span style=color:#a6e22e>status</span>.<span style=color:#a6e22e>apply</span>(
  (<span style=color:#a6e22e>status</span>) <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>status</span>.<span style=color:#a6e22e>loadBalancer</span>.<span style=color:#a6e22e>ingress</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>hostname</span>
);

<span style=color:#75715e>// Get access to the config
</span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>config</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>pulumi</span>.<span style=color:#a6e22e>Config</span>();
<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>awsConfig</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>pulumi</span>.<span style=color:#a6e22e>Config</span>(<span style=color:#e6db74>&#39;aws&#39;</span>);

<span style=color:#75715e>// Create a domainname for this ingress using Cloudflare
</span><span style=color:#75715e></span><span style=color:#66d9ef>new</span> <span style=color:#a6e22e>cloudflare</span>.<span style=color:#a6e22e>Record</span>(<span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>name</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-dns`</span>, {
  <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`charts`</span>,
  <span style=color:#a6e22e>zoneId</span>: <span style=color:#66d9ef>config.requireSecret</span>(<span style=color:#e6db74>&#39;zoneId&#39;</span>),
  <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;A&#39;</span>,
  <span style=color:#a6e22e>value</span>: <span style=color:#66d9ef>ingressUrl</span>,
  <span style=color:#a6e22e>proxied</span>: <span style=color:#66d9ef>true</span>,
});
</code></pre></div><p>This will</p><ul><li>create a k8s provider, this provider is similar to setting up your kubeconfig on your computer to execute commands on the cluster;</li><li>setup a namespace to deploy all the resources in;</li><li>deploy the ingress-nginx ingress controller into that namespace from the official helm chart repository;</li><li>when it it deployed, we will fetch the ingress URL from the service, on AWS you get a hostname, on EKS/AKS an IP address;</li><li>and finally we create an CNAME record in Cloudflare for charts.vanderveer.be to the hostname of our ingress ELB.</li></ul><p>Now we will update our infrastructure by running <code>pulumi up</code> again.</p><img src=/images/2021/chartmuseum-mirror/dns.gif alt="Deploying the ingress and domainname" class=center style=border-radius:8px><h2 id=creating-your-own-charts>Creating your own charts<a href=#creating-your-own-charts class=hanchor arialabel=Anchor>&#8983;</a></h2><h2 id=publish-your-charts-to-chartmuseum-via-github-actions>Publish your charts to ChartMuseum via Github Actions<a href=#publish-your-charts-to-chartmuseum-via-github-actions class=hanchor arialabel=Anchor>&#8983;</a></h2><h2 id=mirroring-other-chart-repositories>Mirroring other chart repositories<a href=#mirroring-other-chart-repositories class=hanchor arialabel=Anchor>&#8983;</a></h2></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>&copy 2021</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=https://vanderveer.be/assets/main.js></script><script src=https://vanderveer.be/assets/prism.js></script></div></body></html>